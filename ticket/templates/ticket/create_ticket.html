{% extends 'base/base.html' %}
{% load static %}

{% block title %}Crear Solicitud - SIGETIC{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .ticket-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .welcome-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .welcome-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: #c1121f;
        margin-bottom: 12px;
    }

    .welcome-header p {
        font-size: 16px;
        color: #666;
        margin: 0;
    }

    .progress-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        gap: 8px;
    }

    .progress-step {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        background: white;
    }

    .step-circle.active {
        background: linear-gradient(135deg, #c1121f 0%, #a1101a 100%);
        color: white;
        border: 2px solid #c1121f;
    }

    .step-circle.inactive {
        background: #e0e0e0;
        color: #999;
        border: 2px solid #e0e0e0;
    }

    .step-line {
        height: 3px;
        width: 100px;
        background: #e0e0e0;
        transition: all 0.3s ease;
    }

    .step-line.active {
        background: linear-gradient(90deg, #c1121f 0%, #a1101a 100%);
    }

    .form-card {
        background: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .form-step {
        display: none;
        opacity: 0;
        transform: translateX(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .form-step.active {
        display: block;
        opacity: 1;
        transform: translateX(0);
    }

    .step-title {
        font-size: 28px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 12px;
    }

    .step-subtitle {
        font-size: 16px;
        color: #666;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .search-input-wrapper {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background-color: #fafafa;
        font-family: inherit;
    }

    .search-input:focus {
        outline: none;
        border-color: #c1121f;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(193, 18, 31, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        pointer-events: none;
    }

    .clear-btn {
        position: absolute;
        right: 45px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 18px;
        padding: 4px 8px;
        transition: color 0.3s ease;
    }

    .clear-btn:hover {
        color: #c1121f;
    }

    .info-box {
        background: #e0f2fe;
        border-left: 4px solid #0ea5e9;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }

    .info-box-title {
        font-weight: 600;
        color: #0c4a6e;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .info-box-text {
        color: #075985;
        font-size: 13px;
        line-height: 1.6;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background-color: #fafafa;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: #c1121f;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(193, 18, 31, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
    }
    
    /* Estilos para el contenedor de descripci√≥n con micr√≥fono */
    .descripcion-wrapper {
        position: relative;
    }
    
    .descripcion-wrapper textarea {
        padding-right: 60px;
    }
    
    .mic-button {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: #c1121f;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 18px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(193, 18, 31, 0.3);
        pointer-events: auto;
    }
    
    .mic-button:hover {
        background: #a1101a;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(193, 18, 31, 0.4);
    }
    
    .mic-button.recording {
        background: #dc2626;
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    .mic-button.recording::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(220, 38, 38, 0.4);
        animation: ripple 1.5s ease-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
    
    @keyframes ripple {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }
    
    .mic-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .speech-status {
        position: absolute;
        right: 60px;
        bottom: 16px;
        font-size: 12px;
        color: #666;
        display: none;
        align-items: center;
        gap: 6px;
    }
    
    .speech-status.active {
        display: flex;
    }
    
    .speech-status.recording {
        color: #dc2626;
        font-weight: 600;
    }
    
    .speech-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: blink 1s ease-in-out infinite;
    }
    
    @keyframes blink {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
    }

    /* Estilos para subir/tomar fotos */
    .image-upload-container {
        margin-top: 12px;
    }
    
    .btn-image-upload {
        width: 100%;
        padding: 12px 20px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin-bottom: 16px;
    }
    
    .btn-image-upload:hover {
        border-color: #c1121f;
        background: #fef2f2;
        color: #c1121f;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(193, 18, 31, 0.15);
    }
    
    .btn-image-upload span:first-child {
        font-size: 20px;
    }
    
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }
    
    .image-preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e0e0e0;
        aspect-ratio: 1;
    }
    
    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
    .image-preview-item .remove-image {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(220, 38, 38, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .image-preview-item .remove-image:hover {
        background: rgba(220, 38, 38, 1);
        transform: scale(1.1);
    }

    .summary-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 24px;
        margin-top: 24px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-weight: 500;
        color: #1a1a1a;
    }

    .summary-value {
        color: #666;
        text-align: right;
        flex: 1;
    }

    .summary-value-badge {
        display: inline-block;
        background: #c1121f;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .summary-description {
        background: #f3f4f6;
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
        color: #666;
        font-size: 14px;
        line-height: 1.6;
    }

    .alert-box {
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .alert-info {
        background: #e0f2fe;
        border-left: 4px solid #0ea5e9;
        color: #075985;
    }

    .alert-success {
        background: #d1fae5;
        border-left: 4px solid #10b981;
        color: #065f46;
    }
    
    .alert-error {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
    }

    .alert-icon {
        font-size: 20px;
        flex-shrink: 0;
    }

    .alert-text {
        font-size: 14px;
        line-height: 1.6;
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        margin-top: 32px;
    }

    .btn {
        padding: 12px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-secondary {
        background: white;
        color: #666;
        border: 2px solid #e0e0e0;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #c1121f;
        color: #c1121f;
    }

    .btn-primary {
        background: linear-gradient(135deg, #c1121f 0%, #a1101a 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(193, 18, 31, 0.3);
    }

    .hidden {
        display: none;
    }
    
    #subcategoria-container {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #subcategoria-container select.form-control,
    #subcategoria-container select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background-color: #fafafa;
        font-family: inherit;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 12px;
        padding-right: 40px;
    }
    
    #subcategoria-container select.form-control:focus,
    #subcategoria-container select:focus {
        outline: none;
        border-color: #c1121f;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(193, 18, 31, 0.1);
    }
    
    /* Select2 Custom Styles */
    .select2-container--default .select2-selection--single {
        height: 48px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: #fafafa;
        transition: all 0.3s ease;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 48px;
        padding-left: 16px;
        padding-right: 40px;
        color: #333;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px;
        right: 16px;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #c1121f;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(193, 18, 31, 0.1);
    }
    
    .select2-dropdown {
        border: 2px solid #c1121f;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(193, 18, 31, 0.15);
    }
    
    .select2-search--dropdown .select2-search__field {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 12px;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
        border-color: #c1121f;
        outline: none;
    }
    
    .select2-results__option--highlighted {
        background-color: #c1121f;
    }
    
    .select2-container {
        width: 100% !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="ticket-container">
    <!-- Header de Bienvenida -->
    <div class="welcome-header">
        <h1>¬°Ind√≠canos tu problema!</h1>
        <p>Rellena este formulario paso a paso y un t√©cnico te atender√° muy pronto.</p>
            </div>

    <!-- Indicador de Progreso -->
    <div class="progress-indicator">
        <div class="progress-step">
            <div class="step-circle active" data-step="1">1</div>
            <div class="step-line"></div>
        </div>
        <div class="progress-step">
            <div class="step-circle inactive" data-step="2">2</div>
            <div class="step-line"></div>
        </div>
        <div class="progress-step">
            <div class="step-circle inactive" data-step="3">3</div>
        </div>
    </div>

    <form method="post" id="ticket-form" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Mostrar mensajes de error -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert-box {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}" style="margin-bottom: 24px;">
                    <span class="alert-icon">{% if message.tags == 'error' %}‚ùå{% elif message.tags == 'success' %}‚úì{% else %}‚ÑπÔ∏è{% endif %}</span>
                    <div class="alert-text">{{ message }}</div>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Mostrar errores del formulario -->
        {% if form.errors %}
            <div class="alert-box alert-error" style="margin-bottom: 24px;">
                <span class="alert-icon">‚ùå</span>
                <div class="alert-text">
                    <strong>Por favor, corrige los siguientes errores:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ field }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}
        
        <!-- Paso 1: Ubicaci√≥n y Departamento -->
        <div class="form-card form-step active" data-step="1">
            <h2 class="step-title">Ubicaci√≥n y Departamento</h2>
            <p class="step-subtitle">Selecciona tu sede y dependencia. Los valores se preseleccionan autom√°ticamente seg√∫n tu perfil, pero puedes cambiarlos.</p>
            
            <div class="form-group">
                <label for="id_sede">{{ form.sede.label }}</label>
                <div class="search-input-wrapper">
                    {{ form.sede }}
                    <button type="button" class="clear-btn" id="clear-sede" style="display: none;">√ó</button>
                    </div>
                {% if form.sede.errors %}
                    <div style="color: #c33; font-size: 14px; margin-top: 8px;">{{ form.sede.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_dependencia">{{ form.dependencia.label }}</label>
                <div class="search-input-wrapper">
                    {{ form.dependencia }}
                    <button type="button" class="clear-btn" id="clear-dependencia" style="display: none;">√ó</button>
                </div>
                {% if form.dependencia.errors %}
                    <div style="color: #c33; font-size: 14px; margin-top: 8px;">{{ form.dependencia.errors }}</div>
                {% endif %}
            </div>

            <div class="info-box">
                <div class="info-box-title">Selecci√≥n autom√°tica editable</div>
                <div class="info-box-text">
                    Tu sede y dependencia se preseleccionan autom√°ticamente seg√∫n tu perfil. Puedes hacer clic en los campos para buscar y cambiar las selecciones. Usa el bot√≥n X para limpiar la selecci√≥n.
                </div>
            </div>

            <div class="navigation-buttons">
                <div></div>
                <button type="button" class="btn btn-primary" onclick="nextStep()">Siguiente</button>
            </div>
        </div>

        <!-- Paso 2: Categor√≠a y Subcategor√≠a -->
        <div class="form-card form-step" data-step="2">
            <h2 class="step-title">Categor√≠a y Subcategor√≠a</h2>
            <p class="step-subtitle">Selecciona el tipo de problema</p>
            
            <div class="form-group">
                <label for="id_categoria">{{ form.categoria.label }}</label>
                {{ form.categoria }}
                {% if form.categoria.errors %}
                    <div style="color: #c33; font-size: 14px; margin-top: 8px;">{{ form.categoria.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group" id="subcategoria-container" style="display: none; margin-top: 24px;">
                <label for="id_subcategoria" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Tipo de problema espec√≠fico</label>
                <p style="color: #666; margin-bottom: 12px; font-size: 14px;">Seleccione una subcategor√≠a</p>
                {{ form.subcategoria }}
                {% if form.subcategoria.errors %}
                    <div style="color: #c33; font-size: 14px; margin-top: 8px;">{{ form.subcategoria.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="descripcion">Descripci√≥n detallada</label>
                <div class="descripcion-wrapper">
                    {{ form.descripcion }}
                    <button type="button" class="mic-button" id="mic-button" title="Haz clic para hablar">
                        üé§
                    </button>
                    <div class="speech-status" id="speech-status">
                        <span class="status-dot"></span>
                        <span id="speech-status-text">Escuchando...</span>
                    </div>
                </div>
                <p style="color: #666; font-size: 13px; margin-top: 8px;">
                    üí° <strong>Tip:</strong> Haz clic en el micr√≥fono para dictar tu descripci√≥n con voz
                </p>
                {% if form.descripcion.errors %}
                    <div style="color: #c33; font-size: 14px; margin-top: 8px;">{{ form.descripcion.errors }}</div>
                {% endif %}
            </div>

            <!-- Campo para im√°genes -->
            <div class="form-group">
                <label>Im√°genes (opcional - m√°ximo 2)</label>
                <div class="image-upload-container">
                    <button type="button" class="btn-image-upload" id="btn-upload-image">
                        <span>üì∑</span>
                        <span>Subir o tomar foto</span>
                    </button>
                    <input type="file" id="id_imagenes" name="imagenes" multiple accept="image/*" capture="environment" style="display: none;">
                    <div class="image-preview-container" id="image-preview-container"></div>
                </div>
                <p style="color: #666; font-size: 13px; margin-top: 8px;">
                    üí° Puedes subir o tomar hasta 2 fotos. En m√≥vil, se abrir√° la c√°mara autom√°ticamente.
                </p>
            </div>

            <div class="navigation-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Anterior</button>
                <button type="button" class="btn btn-primary" onclick="nextStep()">Siguiente</button>
            </div>
        </div>

        <!-- Paso 3: Resumen -->
        <div class="form-card form-step" data-step="3">
            <h2 class="step-title">Resumen</h2>
            <p class="step-subtitle">Revisa y env√≠a</p>
            
            <h3 style="font-size: 20px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;">Resumen de tu solicitud</h3>
            <p style="color: #666; margin-bottom: 24px;">Revisa la informaci√≥n antes de enviar tu solicitud de soporte.</p>

            <div class="summary-card">
                <div class="summary-item">
                    <span class="summary-label">Sede</span>
                    <span class="summary-value" id="summary-sede">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Dependencia</span>
                    <span class="summary-value" id="summary-dependencia">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Categor√≠a</span>
                    <span class="summary-value">
                        <span class="summary-value-badge" id="summary-categoria">-</span>
                    </span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Subcategor√≠a</span>
                    <span class="summary-value" id="summary-subcategoria">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Descripci√≥n</span>
                    <div class="summary-value">
                        <div class="summary-description" id="summary-descripcion">-</div>
                    </div>
                </div>
            </div>

            <div class="alert-box alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <div class="alert-text">
                    ¬øTodo se ve correcto? Una vez que env√≠es esta solicitud, se crear√° un ticket y un t√©cnico se pondr√° en contacto contigo a la brevedad.
                </div>
            </div>

            <div class="alert-box alert-success">
                <span class="alert-icon">‚úì</span>
                <div class="alert-text">
                    <strong>Ticket listo para enviar</strong> Todos los campos requeridos han sido completados
                    </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Anterior</button>
                <button type="submit" class="btn btn-primary" onclick="return validateAndSubmit(event)">Enviar solicitud de soporte</button>
            </div>
        </div>
        </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery (requerido para Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // Verificar que jQuery se haya cargado correctamente
    if (typeof jQuery === 'undefined') {
        console.error('jQuery no se carg√≥ correctamente');
    } else {
        console.log('jQuery cargado correctamente, versi√≥n:', jQuery.fn.jquery);
    }
    
    // Verificar que Select2 se haya cargado correctamente
    if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 === 'undefined') {
        console.error('Select2 no se carg√≥ correctamente');
    } else if (typeof jQuery !== 'undefined') {
        console.log('Select2 cargado correctamente');
    }
let currentStep = 1;
const totalSteps = 3;

function updateProgress() {
    // Actualizar c√≠rculos y l√≠neas del indicador de progreso
    const progressSteps = document.querySelectorAll('.progress-step');
    
    progressSteps.forEach((stepContainer, index) => {
        const stepNumber = index + 1;
        const circle = stepContainer.querySelector('.step-circle');
        const line = stepContainer.querySelector('.step-line');
        const step = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
        const prevButton = step?.querySelector('.btn-secondary');
        
        // Actualizar estado del c√≠rculo
        if (stepNumber <= currentStep) {
            circle?.classList.remove('inactive');
            circle?.classList.add('active');
        } else {
            circle?.classList.remove('active');
            circle?.classList.add('inactive');
        }
        
        // Actualizar l√≠nea (solo si hay una l√≠nea en este contenedor)
        if (line) {
            if (stepNumber < currentStep) {
                // La l√≠nea antes del paso actual debe estar activa si ya pasamos ese paso
                line.classList.add('active');
            } else {
                line.classList.remove('active');
            }
        }
        
        // Actualizar visibilidad del paso del formulario
        if (stepNumber === currentStep) {
            step?.classList.add('active');
            // Mostrar bot√≥n anterior si no es el primer paso
            if (prevButton) {
                prevButton.style.visibility = currentStep > 1 ? 'visible' : 'hidden';
            }
        } else {
            step?.classList.remove('active');
        }
    });
    
    // Activar l√≠nea anterior al paso actual
    if (currentStep > 1) {
        const previousStepContainer = progressSteps[currentStep - 2];
        const previousLine = previousStepContainer?.querySelector('.step-line');
        if (previousLine) {
            previousLine.classList.add('active');
        }
    }
}

// Funci√≥n para validar y enviar el formulario
function validateAndSubmit(event) {
    event.preventDefault();
    
    // Verificar que la categor√≠a est√© seleccionada
    const categoriaSelect = document.getElementById('id_categoria');
    if (!categoriaSelect || !categoriaSelect.value) {
        alert('Por favor, selecciona una categor√≠a antes de enviar.');
        // Volver al paso 2
        currentStep = 2;
        updateProgress();
        return false;
    }
    
    // Verificar descripci√≥n
    const descripcionTextarea = document.getElementById('descripcion') || document.getElementById('id_descripcion');
    if (!descripcionTextarea || !descripcionTextarea.value || !descripcionTextarea.value.trim()) {
        alert('Por favor, ingresa una descripci√≥n del problema antes de enviar.');
        // Volver al paso 2
        currentStep = 2;
        updateProgress();
        return false;
    }
    
    // Verificar y asegurar que las im√°genes est√©n en el input antes de enviar
    const fileInput = document.getElementById('id_imagenes');
    if (fileInput) {
        console.log('üîç Verificando archivos antes de enviar...');
        console.log('   - Archivos en input:', fileInput.files.length);
        console.log('   - selectedFiles (global):', typeof window.selectedFiles !== 'undefined' ? window.selectedFiles.length : 'no definido');
        
        // Si hay archivos seleccionados pero no est√°n en el input, actualizarlos
        if (typeof window.selectedFiles !== 'undefined' && window.selectedFiles.length > 0) {
            console.log('   - Actualizando input con archivos seleccionados...');
            const dataTransfer = new DataTransfer();
            window.selectedFiles.forEach(file => {
                dataTransfer.items.add(file);
            });
            fileInput.files = dataTransfer.files;
            console.log('   - Archivos actualizados en input:', fileInput.files.length);
        }
        
        // Verificar nuevamente
        if (fileInput.files.length > 0) {
            console.log('   ‚úÖ Archivos listos para enviar:', fileInput.files.length);
            for (let i = 0; i < fileInput.files.length; i++) {
                console.log(`      ${i + 1}. ${fileInput.files[i].name} (${fileInput.files[i].size} bytes)`);
            }
        } else {
            console.log('   ‚ö†Ô∏è No hay archivos en el input');
        }
    }
    
    // Si todo est√° bien, enviar el formulario
    console.log('üì§ Enviando formulario...');
    document.getElementById('ticket-form').submit();
    return true;
}

function nextStep() {
    // Validar campos antes de avanzar
    if (currentStep === 1) {
        // Validar paso 1: Sede y Dependencia son opcionales, pero deber√≠amos permitir avanzar
        // No hay validaci√≥n estricta aqu√≠
    } else if (currentStep === 2) {
        // Validar paso 2: Categor√≠a es obligatoria
        const categoriaSelect = document.getElementById('id_categoria');
        const descripcionTextarea = document.getElementById('descripcion') || document.getElementById('id_descripcion');
        
        // Verificar si hay una categor√≠a seleccionada
        if (!categoriaSelect || !categoriaSelect.value) {
            alert('Por favor, selecciona una categor√≠a antes de continuar.');
            return;
        }
        
        // Verificar descripci√≥n
        if (!descripcionTextarea) {
            alert('Error: No se encontr√≥ el campo de descripci√≥n.');
            console.error('Campo descripci√≥n no encontrado. Buscando por id: descripcion o id_descripcion');
            return;
        }
        
        const descripcionValue = descripcionTextarea.value ? descripcionTextarea.value.trim() : '';
        
        if (!descripcionValue || descripcionValue.length === 0) {
            alert('Por favor, ingresa una descripci√≥n del problema antes de continuar.');
            return;
        }
    }
    
    if (currentStep < totalSteps) {
        // Ocultar paso actual
        const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        if (currentStepElement) {
            currentStepElement.classList.remove('active');
        }
        
        // Avanzar al siguiente paso
        currentStep++;
        
        // Mostrar nuevo paso despu√©s de una peque√±a pausa para la transici√≥n
        setTimeout(() => {
            updateProgress();
            if (currentStep === totalSteps) {
                // Actualizar resumen cuando llegamos al paso 3
                setTimeout(() => {
                    updateSummary();
                }, 200);
            }
        }, 150);
    }
}

function prevStep() {
    if (currentStep > 1) {
        // Ocultar paso actual
        const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        if (currentStepElement) {
            currentStepElement.classList.remove('active');
        }
        
        // Retroceder al paso anterior
        currentStep--;
        
        // Mostrar paso anterior despu√©s de una peque√±a pausa para la transici√≥n
        setTimeout(() => {
            updateProgress();
        }, 150);
    }
}

function loadSubcategorias(categoriaId) {
    console.log('loadSubcategorias llamado con categoriaId:', categoriaId);
    
    const subcategoryContainer = document.getElementById('subcategoria-container');
    const select = document.getElementById('id_subcategoria');
    
    if (!subcategoryContainer) {
        console.error('No se encontr√≥ el contenedor de subcategor√≠a');
        return;
    }
    
    if (!select) {
        console.error('No se encontr√≥ el select de subcategor√≠a');
        return;
    }
    
    if (!categoriaId) {
        subcategoryContainer.style.display = 'none';
        return;
    }   
    
    // Forzar visibilidad inmediata del contenedor
    subcategoryContainer.style.display = 'block';
    subcategoryContainer.style.visibility = 'visible';
    subcategoryContainer.style.opacity = '1';
    
    // Mostrar un mensaje de carga
    select.innerHTML = '<option value="">Cargando subcategor√≠as...</option>';
    select.disabled = true;
    
    // Destruir Select2 si ya est√° inicializado
    if ($(select).hasClass('select2-hidden-accessible')) {
        $(select).select2('destroy');
    }
    
    const url = `{% url 'ticket:get_subcategorias' %}?categoria=${categoriaId}`;
    console.log('Fetching subcategor√≠as desde:', url);
    
    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            
            // Habilitar el select
            select.disabled = false;
            
            // Limpiar opciones anteriores
            select.innerHTML = '<option value="">Seleccione una subcategor√≠a</option>';
            
            if (data && Array.isArray(data) && data.length > 0) {
                console.log('Agregando', data.length, 'subcategor√≠as');
                // Agregar opciones al select
                data.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.id;
                    option.textContent = subcat.nombre;
                    select.appendChild(option);
                });
                
                // Forzar visibilidad del contenedor
                subcategoryContainer.style.display = 'block';
                subcategoryContainer.style.visibility = 'visible';
                subcategoryContainer.style.opacity = '1';
                
                // Remover cualquier estilo inline que pueda estar ocultando
                subcategoryContainer.removeAttribute('hidden');
                
                // Reinicializar Select2 con las nuevas opciones
                $(select).select2({
                    placeholder: 'Buscar y seleccionar subcategor√≠a...',
                    allowClear: true,
                    minimumInputLength: 0,  // Permitir b√∫squeda desde el primer car√°cter
                    language: {
                        noResults: function() {
                            return "No se encontraron resultados";
                        },
                        searching: function() {
                            return "Buscando...";
                        },
                        inputTooShort: function() {
                            return "Escribe para buscar...";
                        }
                    },
                    width: '100%'
                }).on('change', function() {
                    updateSummary();
                    // Si estamos en el paso 3, actualizar resumen
                    if (currentStep === totalSteps) {
                        updateSummary();
                    }
                });
                
                console.log('Subcategor√≠as cargadas. Contenedor display:', subcategoryContainer.style.display);
                console.log('Subcategor√≠as cargadas. Contenedor visible:', subcategoryContainer.offsetHeight > 0);
                
                // Preseleccionar subcategor√≠a si hay una seleccionada previamente
                const initialSubcategoria = select.getAttribute('data-initial-value');
                if (initialSubcategoria) {
                    $(select).val(initialSubcategoria).trigger('change');
                }
                
                // Actualizar resumen si estamos en el paso 3
                if (currentStep === totalSteps) {
                    updateSummary();
                }
            } else {
                console.log('No hay subcategor√≠as para esta categor√≠a');
                // Mostrar mensaje si no hay subcategor√≠as pero mantener visible
                select.innerHTML = '<option value="">No hay subcategor√≠as disponibles</option>';
                subcategoryContainer.style.display = 'block';
                subcategoryContainer.style.visibility = 'visible';
                subcategoryContainer.style.opacity = '1';
                
                // Reinicializar Select2 incluso sin opciones
                $(select).select2({
                    placeholder: 'No hay subcategor√≠as disponibles',
                    allowClear: false,
                    minimumInputLength: 0,
                    language: {
                        noResults: function() {
                            return "No hay subcategor√≠as disponibles";
                        }
                    },
                    width: '100%'
                });
            }
        })
        .catch(error => {
            console.error('Error al cargar subcategor√≠as:', error);
            select.disabled = false;
            select.innerHTML = '<option value="">Error al cargar subcategor√≠as</option>';
            subcategoryContainer.style.display = 'block';
            subcategoryContainer.style.visibility = 'visible';
            subcategoryContainer.style.opacity = '1';
            
            // Reinicializar Select2 incluso con error
            $(select).select2({
                placeholder: 'Error al cargar subcategor√≠as',
                allowClear: false,
                minimumInputLength: 0,
                width: '100%'
            });
        });
}

function loadDependencias(sedeId) {
    const select = document.getElementById('id_dependencia');
    const currentValue = select ? select.value : '';
    
    // Destruir Select2 si ya est√° inicializado
    if (select && $(select).hasClass('select2-hidden-accessible')) {
        $(select).select2('destroy');
    }
    
    fetch(`{% url 'ticket:get_dependencias' %}?sede=${sedeId}`)
        .then(response => response.json())
        .then(data => {
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccione una dependencia</option>';
            data.forEach(dep => {
                const option = document.createElement('option');
                option.value = dep.id;
                option.textContent = dep.nombre;
                if (dep.id == currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Reinicializar Select2 con las nuevas opciones
            $(select).select2({
                placeholder: 'Buscar y seleccionar dependencia...',
                allowClear: true,
                minimumInputLength: 0,  // Permitir b√∫squeda desde el primer car√°cter
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar...";
                    }
                },
                width: '100%'
            }).on('change', function() {
                updateSummary();
            });
            
            // Restaurar valor seleccionado si existe
            if (currentValue) {
                $(select).val(currentValue).trigger('change');
            }
        })
        .catch(error => console.error('Error:', error));
}

function updateSummary() {
    // Obtener todos los campos del formulario
    const sedeSelect = document.getElementById('id_sede') || document.getElementById('sede-select');
    const dependenciaSelect = document.getElementById('id_dependencia') || document.getElementById('dependencia-select');
    const categoriaSelect = document.getElementById('id_categoria');
    const subcategoriaSelect = document.getElementById('id_subcategoria') || document.getElementById('subcategory-select');
    const descripcionTextarea = document.getElementById('descripcion') || document.getElementById('id_descripcion');
    
    // Actualizar Sede
    let sedeText = 'No seleccionada';
    if (sedeSelect) {
        if ($(sedeSelect).hasClass('select2-hidden-accessible')) {
            // Si usa Select2, obtener el texto de Select2
            sedeText = $(sedeSelect).select2('data')[0]?.text || '';
        } else if (sedeSelect.selectedIndex >= 0) {
            // Si no usa Select2, obtener del select normal
            sedeText = sedeSelect.options[sedeSelect.selectedIndex]?.text || '';
        }
    }
    document.getElementById('summary-sede').textContent = sedeText || 'No seleccionada';
    
    // Actualizar Dependencia
    let dependenciaText = 'No seleccionada';
    if (dependenciaSelect) {
        if ($(dependenciaSelect).hasClass('select2-hidden-accessible')) {
            // Si usa Select2, obtener el texto de Select2
            dependenciaText = $(dependenciaSelect).select2('data')[0]?.text || '';
        } else if (dependenciaSelect.selectedIndex >= 0) {
            // Si no usa Select2, obtener del select normal
            dependenciaText = dependenciaSelect.options[dependenciaSelect.selectedIndex]?.text || '';
        }
    }
    document.getElementById('summary-dependencia').textContent = dependenciaText || 'No seleccionada';
    
    // Actualizar Categor√≠a
    let categoriaName = '-';
    if (categoriaSelect && categoriaSelect.selectedIndex >= 0) {
        categoriaName = categoriaSelect.options[categoriaSelect.selectedIndex]?.text || '-';
    }
    
    const summaryCategoria = document.getElementById('summary-categoria');
    if (summaryCategoria) {
        summaryCategoria.textContent = categoriaName;
    }
    
    // Actualizar Subcategor√≠a
    let subcategoriaName = '-';
    if (subcategoriaSelect && subcategoriaSelect.value) {
        if ($(subcategoriaSelect).hasClass('select2-hidden-accessible')) {
            // Si usa Select2, obtener el texto de Select2
            const select2Data = $(subcategoriaSelect).select2('data');
            subcategoriaName = select2Data && select2Data.length > 0 ? select2Data[0].text : '-';
        } else if (subcategoriaSelect.selectedIndex >= 0) {
            // Si no usa Select2, obtener del select normal
            subcategoriaName = subcategoriaSelect.options[subcategoriaSelect.selectedIndex]?.text || '-';
        }
    }
    document.getElementById('summary-subcategoria').textContent = subcategoriaName;
    
    // Actualizar Descripci√≥n
    let descripcionText = '-';
    if (descripcionTextarea && descripcionTextarea.value) {
        descripcionText = descripcionTextarea.value.trim();
    }
    document.getElementById('summary-descripcion').textContent = descripcionText;
}

// Inicializar Select2 para autocomplete
function initSelect2() {
    // Verificar que jQuery y Select2 est√©n disponibles
    if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
        console.error('jQuery o Select2 no est√°n disponibles. Reintentando en 500ms...');
        setTimeout(initSelect2, 500);
        return;
    }
    
    console.log('Inicializando Select2...');
    
    // Inicializar Select2 para Sede
    const sedeSelect = document.getElementById('id_sede');
    if (sedeSelect) {
        // Destruir Select2 si ya est√° inicializado
        if ($(sedeSelect).hasClass('select2-hidden-accessible')) {
            $(sedeSelect).select2('destroy');
        }
        
        try {
            $(sedeSelect).select2({
                placeholder: 'Buscar y seleccionar sede...',
                allowClear: true,
                minimumInputLength: 0,  // Permitir b√∫squeda desde el primer car√°cter
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar...";
                    }
                },
                width: '100%'
            }).on('change', function() {
                updateSummary();
                // Filtrar dependencias por sede
                if (this.value) {
                    loadDependencias(this.value);
                } else {
                    // Resetear dependencias si no hay sede
                    const dependenciaSelect = document.getElementById('id_dependencia');
                    if (dependenciaSelect) {
                        dependenciaSelect.innerHTML = '<option value="">Seleccione una dependencia</option>';
                        dependenciaSelect.value = '';
                        if ($(dependenciaSelect).hasClass('select2-hidden-accessible')) {
                            $(dependenciaSelect).select2('destroy');
                            initSelect2();
                        }
                    }
                }
            });
            console.log('Select2 inicializado para Sede');
        } catch (error) {
            console.error('Error al inicializar Select2 para Sede:', error);
        }
    } else {
        console.warn('No se encontr√≥ el select de Sede');
    }
    
    // Inicializar Select2 para Categor√≠a
    const categoriaSelect = document.getElementById('id_categoria');
    if (categoriaSelect) {
        // Destruir Select2 si ya est√° inicializado
        if ($(categoriaSelect).hasClass('select2-hidden-accessible')) {
            $(categoriaSelect).select2('destroy');
        }
        
        try {
            $(categoriaSelect).select2({
                placeholder: 'Buscar y seleccionar categor√≠a...',
                allowClear: false,
                minimumInputLength: 0,
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar...";
                    }
                },
                width: '100%'
            }).on('change', function() {
                if (this.value) {
                    loadSubcategorias(this.value);
                } else {
                    const subcategoryContainer = document.getElementById('subcategoria-container');
                    if (subcategoryContainer) {
                        subcategoryContainer.style.display = 'none';
                    }
                }
                updateSummary();
            });
            console.log('Select2 inicializado para Categor√≠a');
        } catch (error) {
            console.error('Error al inicializar Select2 para Categor√≠a:', error);
        }
    } else {
        console.warn('No se encontr√≥ el select de Categor√≠a');
    }
    
    // Inicializar Select2 para Dependencia
    const dependenciaSelect = document.getElementById('id_dependencia');
    if (dependenciaSelect) {
        // Destruir Select2 si ya est√° inicializado
        if ($(dependenciaSelect).hasClass('select2-hidden-accessible')) {
            $(dependenciaSelect).select2('destroy');
        }
        
        try {
            $(dependenciaSelect).select2({
                placeholder: 'Buscar y seleccionar dependencia...',
                allowClear: true,
                minimumInputLength: 0,  // Permitir b√∫squeda desde el primer car√°cter
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar...";
                    }
                },
                width: '100%'
            }).on('change', function() {
                updateSummary();
            });
            console.log('Select2 inicializado para Dependencia');
        } catch (error) {
            console.error('Error al inicializar Select2 para Dependencia:', error);
        }
    } else {
        console.warn('No se encontr√≥ el select de Dependencia');
    }
    
    // Inicializar Select2 para Subcategor√≠a (si est√° visible)
    const subcategoriaSelect = document.getElementById('id_subcategoria');
    if (subcategoriaSelect && subcategoriaSelect.offsetParent !== null) {
        // Destruir Select2 si ya est√° inicializado
        if ($(subcategoriaSelect).hasClass('select2-hidden-accessible')) {
            $(subcategoriaSelect).select2('destroy');
        }
        
        try {
            $(subcategoriaSelect).select2({
                placeholder: 'Buscar y seleccionar subcategor√≠a...',
                allowClear: true,
                minimumInputLength: 0,  // Permitir b√∫squeda desde el primer car√°cter
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar...";
                    }
                },
                width: '100%'
            }).on('change', function() {
                updateSummary();
                // Si estamos en el paso 3, actualizar resumen
                if (currentStep === totalSteps) {
                    updateSummary();
                }
            });
            console.log('Select2 inicializado para Subcategor√≠a');
        } catch (error) {
            console.error('Error al inicializar Select2 para Subcategor√≠a:', error);
        }
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    
    // Funci√≥n para inicializar Select2 cuando est√© disponible
    function waitForSelect2() {
        if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
            console.log('jQuery y Select2 est√°n disponibles');
            // Inicializar Select2 despu√©s de un peque√±o delay para asegurar que el DOM est√© listo
            setTimeout(() => {
                initSelect2();
            }, 200);
        } else {
            console.log('Esperando jQuery y Select2...');
            setTimeout(waitForSelect2, 100);
        }
    }
    
    // Comenzar a esperar por Select2
    waitForSelect2();
    
    // Cargar dependencias si hay una sede preseleccionada
    const sedeSelect = document.getElementById('id_sede');
    if (sedeSelect && sedeSelect.value) {
        loadDependencias(sedeSelect.value);
    }
    
    // Cargar subcategor√≠as si hay una categor√≠a preseleccionada (ya se maneja en initSelect2)
    const categoriaSelect = document.getElementById('id_categoria');
    if (categoriaSelect && categoriaSelect.value) {
        loadSubcategorias(categoriaSelect.value);
    }
    
    // Actualizar resumen cuando cambian los campos (sedeSelect ya obtenido arriba)
    const dependenciaSelect = document.getElementById('id_dependencia');
    const subcategoriaSelect = document.getElementById('id_subcategoria');
    const descripcionTextarea = document.getElementById('descripcion') || document.getElementById('id_descripcion');
    
    if (sedeSelect) {
        sedeSelect.addEventListener('change', function() {
            updateSummary();
            // Filtrar dependencias por sede
            if (this.value) {
                loadDependencias(this.value);
            } else {
                // Resetear dependencias si no hay sede
                if (dependenciaSelect) {
                    dependenciaSelect.innerHTML = '<option value="">Seleccione una dependencia</option>';
                    dependenciaSelect.value = '';
                }
            }
        });
    }
    if (dependenciaSelect) dependenciaSelect.addEventListener('change', updateSummary);
    if (subcategoriaSelect) {
        subcategoriaSelect.addEventListener('change', function() {
            updateSummary();
            // Si estamos en el paso 3, actualizar resumen
            if (currentStep === totalSteps) {
                updateSummary();
            }
        });
    }
    if (descripcionTextarea) {
        descripcionTextarea.addEventListener('input', function() {
            // Actualizar resumen cuando se escribe en la descripci√≥n
            if (currentStep === totalSteps) {
                updateSummary();
            }
        });
    }
    
    // Inicializar reconocimiento de voz (Speech-to-Text) despu√©s de un peque√±o delay
    setTimeout(function() {
        initSpeechRecognition();
    }, 500);
    
    // Inicializar funcionalidad de im√°genes
    initImageUpload();
});

// Funci√≥n para inicializar el reconocimiento de voz
function initSpeechRecognition() {
    console.log('Inicializando reconocimiento de voz...');
    
    const micButton = document.getElementById('mic-button');
    const descripcionTextarea = document.getElementById('descripcion') || document.getElementById('id_descripcion');
    const speechStatus = document.getElementById('speech-status');
    const speechStatusText = document.getElementById('speech-status-text');
    
    console.log('Elementos encontrados:', {
        micButton: !!micButton,
        descripcionTextarea: !!descripcionTextarea,
        speechStatus: !!speechStatus,
        speechStatusText: !!speechStatusText
    });
    
    if (!micButton) {
        console.error('No se encontr√≥ el bot√≥n de micr√≥fono');
        return;
    }
    
    if (!descripcionTextarea) {
        console.error('No se encontr√≥ el textarea de descripci√≥n');
        return;
    }
    
    // Verificar si el navegador soporta reconocimiento de voz
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    console.log('SpeechRecognition disponible:', !!SpeechRecognition);
    
    if (!SpeechRecognition) {
        // El navegador no soporta reconocimiento de voz
        console.warn('El navegador no soporta reconocimiento de voz');
        micButton.disabled = true;
        micButton.title = 'Tu navegador no soporta reconocimiento de voz. Usa Chrome, Edge o Safari.';
        micButton.style.opacity = '0.5';
        micButton.style.cursor = 'not-allowed';
        alert('Tu navegador no soporta reconocimiento de voz. Por favor, usa Chrome, Edge o Safari para esta funcionalidad.');
        return;
    }
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-ES'; // Espa√±ol
    recognition.continuous = true; // Continuar escuchando
    recognition.interimResults = true; // Mostrar resultados intermedios
    
    let isRecording = false;
    let finalTranscript = '';
    
    // Funci√≥n para actualizar el estado visual
    function updateStatus(text, isActive, isRecordingState) {
        if (speechStatus && speechStatusText) {
            speechStatusText.textContent = text;
            speechStatus.classList.toggle('active', isActive);
            speechStatus.classList.toggle('recording', isRecordingState);
        }
        
        if (micButton) {
            micButton.classList.toggle('recording', isRecordingState);
        }
    }
    
    // Evento cuando se inicia el reconocimiento
    recognition.onstart = function() {
        console.log('Reconocimiento de voz iniciado');
        isRecording = true;
        finalTranscript = descripcionTextarea.value || '';
        updateStatus('Escuchando...', true, true);
        micButton.textContent = 'üî¥';
        micButton.title = 'Haz clic para detener';
    };
    
    // Evento cuando se reciben resultados
    recognition.onresult = function(event) {
        console.log('Resultado recibido:', event);
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Actualizar el textarea con el texto final + intermedio
        descripcionTextarea.value = finalTranscript + interimTranscript;
        
        // Actualizar resumen si estamos en el paso 3
        if (typeof currentStep !== 'undefined' && currentStep === totalSteps) {
            updateSummary();
        }
        
        // Disparar evento input para que otros listeners se activen
        descripcionTextarea.dispatchEvent(new Event('input', { bubbles: true }));
    };
    
    // Evento cuando hay un error
    recognition.onerror = function(event) {
        console.error('Error en reconocimiento de voz:', event.error);
        isRecording = false;
        updateStatus('', false, false);
        micButton.textContent = 'üé§';
        micButton.title = 'Haz clic para hablar';
        
        let errorMessage = 'Error al reconocer voz';
        switch(event.error) {
            case 'no-speech':
                errorMessage = 'No se detect√≥ voz. Intenta de nuevo.';
                break;
            case 'audio-capture':
                errorMessage = 'No se pudo acceder al micr√≥fono. Verifica los permisos en la configuraci√≥n del navegador.';
                break;
            case 'not-allowed':
                errorMessage = 'Permiso de micr√≥fono denegado. Por favor, permite el acceso al micr√≥fono en la configuraci√≥n del navegador y recarga la p√°gina.';
                break;
            case 'network':
                errorMessage = 'Error de red. Verifica tu conexi√≥n a internet.';
                break;
            case 'aborted':
                // Ignorar errores de aborto (cuando se detiene manualmente)
                return;
        }
        
        alert(errorMessage);
    };
    
    // Evento cuando termina el reconocimiento
    recognition.onend = function() {
        console.log('Reconocimiento de voz terminado');
        isRecording = false;
        updateStatus('', false, false);
        micButton.textContent = 'üé§';
        micButton.title = 'Haz clic para hablar';
    };
    
    // Manejar clic en el bot√≥n de micr√≥fono
    micButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Bot√≥n de micr√≥fono clickeado, isRecording:', isRecording);
        
        if (isRecording) {
            // Detener el reconocimiento
            console.log('Deteniendo reconocimiento...');
            recognition.stop();
            updateStatus('', false, false);
        } else {
            // Iniciar el reconocimiento
            console.log('Iniciando reconocimiento...');
            try {
                finalTranscript = descripcionTextarea.value || '';
                recognition.start();
            } catch (error) {
                console.error('Error al iniciar reconocimiento:', error);
                alert('No se pudo iniciar el reconocimiento de voz. Error: ' + error.message + '\n\nAseg√∫rate de que el navegador tenga permisos para usar el micr√≥fono.');
            }
        }
    });
    
    // Permitir detener con Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && isRecording) {
            recognition.stop();
        }
    });
    
    console.log('Reconocimiento de voz inicializado correctamente');
}

// Funci√≥n para inicializar la funcionalidad de subir/tomar fotos
function initImageUpload() {
    const btnUploadImage = document.getElementById('btn-upload-image');
    const fileInput = document.getElementById('id_imagenes');
    const previewContainer = document.getElementById('image-preview-container');
    
    const MAX_IMAGES = 2;
    let selectedFiles = [];
    
    // Hacer selectedFiles global para que est√© disponible en validateAndSubmit
    window.selectedFiles = selectedFiles;
    
    if (!btnUploadImage || !fileInput || !previewContainer) {
        console.warn('No se encontraron los elementos necesarios para la subida de im√°genes');
        return;
    }
    
    // Funci√≥n para mostrar previsualizaci√≥n de im√°genes
    function updatePreview() {
        previewContainer.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview ${index + 1}">
                    <button type="button" class="remove-image" data-index="${index}">√ó</button>
                `;
                previewContainer.appendChild(previewItem);
                
                // Agregar evento para eliminar imagen
                previewItem.querySelector('.remove-image').addEventListener('click', function() {
                    removeImage(index);
                });
            };
            reader.readAsDataURL(file);
        });
        
        // Actualizar el input file con los archivos seleccionados
        updateFileInput();
        
        // Actualizar estado del bot√≥n
        updateButtonState();
    }
    
    // Funci√≥n para actualizar el estado del bot√≥n
    function updateButtonState() {
        if (selectedFiles.length >= MAX_IMAGES) {
            btnUploadImage.disabled = true;
            btnUploadImage.style.opacity = '0.6';
            btnUploadImage.style.cursor = 'not-allowed';
            btnUploadImage.title = `M√°ximo ${MAX_IMAGES} im√°genes permitidas`;
        } else {
            btnUploadImage.disabled = false;
            btnUploadImage.style.opacity = '1';
            btnUploadImage.style.cursor = 'pointer';
            btnUploadImage.title = `Subir o tomar foto (${selectedFiles.length}/${MAX_IMAGES})`;
        }
    }
    
    // Funci√≥n para actualizar el input file
    function updateFileInput() {
        console.log('üîÑ Actualizando input file con', selectedFiles.length, 'archivo(s)');
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => {
            dataTransfer.items.add(file);
            console.log('   - Agregando archivo:', file.name, `(${file.size} bytes)`);
        });
        fileInput.files = dataTransfer.files;
        console.log('   ‚úÖ Input actualizado. Archivos en input:', fileInput.files.length);
        
        // Actualizar tambi√©n la variable global
        window.selectedFiles = selectedFiles;
    }
    
    // Funci√≥n para agregar archivos
    function addFiles(files) {
        const remainingSlots = MAX_IMAGES - selectedFiles.length;
        
        if (remainingSlots <= 0) {
            alert(`Ya has alcanzado el m√°ximo de ${MAX_IMAGES} im√°genes. Elimina una imagen antes de agregar otra.`);
            return;
        }
        
        const filesToAdd = Array.from(files).slice(0, remainingSlots);
        const filesToReject = Array.from(files).slice(remainingSlots);
        
        filesToAdd.forEach(file => {
            if (file.type.startsWith('image/')) {
                selectedFiles.push(file);
                console.log('   ‚úÖ Archivo agregado:', file.name, `(${file.size} bytes, ${file.type})`);
            } else {
                console.log('   ‚ö†Ô∏è Archivo ignorado (no es imagen):', file.name, `(${file.type})`);
            }
        });
        
        // Actualizar variable global
        window.selectedFiles = selectedFiles;
        
        if (filesToReject.length > 0) {
            alert(`Solo se pueden agregar hasta ${MAX_IMAGES} im√°genes. Se agregaron ${filesToAdd.length} imagen(es) y se ignoraron ${filesToReject.length}.`);
        }
        
        updatePreview();
    }
    
    // Funci√≥n para eliminar imagen
    function removeImage(index) {
        selectedFiles.splice(index, 1);
        window.selectedFiles = selectedFiles; // Actualizar global
        updatePreview();
    }
    
    // Bot√≥n para subir/tomar foto (funciona igual en web y m√≥vil)
    btnUploadImage.addEventListener('click', function() {
        if (selectedFiles.length >= MAX_IMAGES) {
            alert(`Ya has alcanzado el m√°ximo de ${MAX_IMAGES} im√°genes. Elimina una imagen antes de agregar otra.`);
            return;
        }
        fileInput.click();
    });
    
    // Manejar selecci√≥n de archivos (funciona para subir y tomar foto)
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            addFiles(e.target.files);
            // Limpiar el input para permitir seleccionar el mismo archivo de nuevo
            fileInput.value = '';
        }
    });
    
    // Inicializar estado del bot√≥n
    updateButtonState();
    
    console.log('Funcionalidad de im√°genes inicializada correctamente');
}
</script>
{% endblock %}
